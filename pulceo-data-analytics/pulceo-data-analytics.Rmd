---
title: PULCEO Data Analytics
output: html_document
params:
  subfolder: "SUMMERSOC2024TEST"
---

```{r, setup, include=FALSE}
# set this option in the first code chunk in the document
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, include = FALSE)
```

```{r warning=FALSE, echo=FALSE}
library(tidyverse)
library(rjson)
library(kableExtra)
```

## Preparation

Read raw data, generated by PULCEO.
```{r warning=FALSE, echo=FALSE}
SUBFOLDER = params$subfolder
dir.create(paste("latex", SUBFOLDER, sep = "/"), showWarnings = FALSE)
CPU_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "CPU_UTIL.csv", sep = "/"), skip = 3)
MEM_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "MEM_UTIL.csv", sep = "/"), skip = 3)
NET_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "NET_UTIL.csv", sep = "/"), skip = 3)
STORAGE_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "STORAGE_UTIL.csv", sep = "/"), skip = 3)
ICMP_RTT_RAW=read.csv(paste("raw", SUBFOLDER, "ICMP_RTT.csv", sep = "/"), skip = 3)
REQUESTS_RAW=read.csv(paste("raw", SUBFOLDER, "REQUESTS.csv", sep = "/"), skip = 3)
TCP_BW_RAW=read.csv(paste("raw", SUBFOLDER, "TCP_BW.csv", sep = "/"), skip = 3)
UDP_BW_RAW=read.csv(paste("raw", SUBFOLDER, "UDP_BW.csv", sep = "/"), skip = 3)
NODES_RAW=fromJSON(file=paste("raw", SUBFOLDER, "NODES.json", sep = "/"))
```

Load functions for pre-processing and table generation:
```{r}
# transformations
TransfromNodeMetricsMetadata <- function (df) {
  df$X_field <- as.factor(df$X_field)
  df$k8sResourceType <- as.factor(df$k8sResourceType)
  df$resourceName <- as.factor(df$resourceName)
  df$X_measurement <- as.factor(df$X_measurement)
  df$metricType <- as.factor(df$metricType)
  df$sourceHost <- as.factor(df$sourceHost)
  df$timestamp <- as.POSIXct(df$timestamp, format = "%Y-%m-%dT%H:%M:%OSZ")
  df <- merge(df, node_mapping, by = "sourceHost")
  return(df)
}

filterResourceUtilForNode <- function(df, field, resourceType, resource) {
  return(df %>% filter(X_field == field) %>% 
           filter(k8sResourceType == resourceType) %>% 
           filter(grepl(resource, resourceName)))
}

CreateSummary <- function(df, resource) {
  df <- df %>% 
    group_by(nodeName) %>% 
    summarize(min = round(min(X_value), 3),
              avg = round(mean(X_value), 3),
              max = round(max(X_value), 3),
              median = round(median(X_value), 3),
              std = round(sd(X_value), 3))
  names(df) <- c(resource, "MIN", "AVG", "MAX", "MEDIAN", "SD")
  return(df)
}

CreateSummaryForNetUtil <- function(df, resource) {
  df <- df %>% 
    group_by(nodeName, X_field) %>% 
    summarize(max = round(max(X_value_final / 1024 / 1024 / 1024), 3))
  return(df)
}

# latex generation
SaveLatexTable <- function(summary, caption, label, filename) {
  latex_table <- kbl(summary, "latex", escape = FALSE, caption = caption, booktabs = FALSE, linesep="", vline="", label = label)
  save_kable(latex_table, paste("latex", SUBFOLDER, filename, sep = "/"))
}

# resources
node_mapping <- Reduce(rbind, lapply(NODES_RAW, function (x) {
  return(c(x$hostname, x$node$name))
}))

node_mapping <- as.data.frame(node_mapping)
names(node_mapping) <- c("sourceHost", "nodeName")

node_mapping_dest <- node_mapping
names(node_mapping_dest) <- c("destinationHost", "nodeNameDest")
```

## CPU utilization

```{r}
CPU_UTIL <- TransfromNodeMetricsMetadata(CPU_UTIL_RAW)
```

### Nodes

```{r}
CPU_UTIL_nodes_summary <- CreateSummary(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "NODE", "pna-k8s-node"), "Node")
SaveLatexTable(CPU_UTIL_nodes_summary, "CPU utilization of all nodes in \\%", "cpu-utilization-of-nodes", "cpu_util_nodes_summary.tex")
```

```{r}
cpu_box_plot <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "NODE", "pna-k8s-node"), aes(x=sourceHost, y=X_value, group=sourceHost)) + geom_boxplot()
```

```{r}
cpu_plot_node <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
cpu_plot_pod_edg_iot_simulator <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "POD", "edge-iot-simulator"), aes(x=timestamp, y=X_value, group=resourceName)) + geom_line() + facet_grid(vars(resourceName))
cpu_plot_pod_pulceo_node_agent <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "POD", "pulceo-node-agent"), aes(x=timestamp, y=X_value, group=resourceName)) + geom_line() + facet_grid(vars(resourceName))
cpu_plot_pod_traefik <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "POD", "traefik"), aes(x=timestamp, y=X_value, group=resourceName)) + geom_line() + facet_grid(vars(resourceName))
```

### Applications

```{r}
CPU_UTIL_pods_summary <- CreateSummary(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "POD", "edge-iot-simulator"), "Pod")
```

## Memory Utilization

```{r}
MEM_UTIL <- TransfromNodeMetricsMetadata(MEM_UTIL_RAW)
```

### Nodes

```{r}
CreateSummary(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "NODE", "pna-k8s-node"), "Node")
```

```{r}
MEM_UTIL_nodes_summary <- CreateSummary(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "NODE", "pna-k8s-node"), "Node")
SaveLatexTable(MEM_UTIL_nodes_summary, "Idle Memory utilization of all nodes in \\%", "memory-utilization-of-nodes", "mem_util_nodes_summary.tex")
```

```{r}
mem_box_plot <- ggplot(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "NODE", "pna-k8s-node"), aes(x=sourceHost, y=X_value, group=sourceHost)) + geom_boxplot()
```

```{r}
mem_plot_node <- ggplot(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
mem_plot_node_pulceo_node_agent <- ggplot(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "POD", "pulceo-node-agent"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
mem_plot_node_traefik <-ggplot(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "POD", "traefik"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
```

### Applications

```{r}
MEM_UTIL_pods_summary <- CreateSummary(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "POD", "edge-iot-simulator"), "Pod")
```

## Storage Utilization

```{r}
STORAGE_UTIL <- TransfromNodeMetricsMetadata(STORAGE_UTIL_RAW)
```

### Nodes

```{r}
STORAGE_UTIL_SUMMARY <- CreateSummary(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "NODE", "pna-k8s-node"), "Node")
SaveLatexTable(STORAGE_UTIL_SUMMARY, "Storage in Percent", "storage-utilization-of-nodes", "storage_util_nodes_summary.tex")
```

```{r}
storage_plot_node <- ggplot(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
storage_plot_pod_pulceo_node_agent <- ggplot(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "POD", "pulceo-node-agent"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
storage_plot_pod_pulceo_node_agent <- ggplot(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "POD", "traefik"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
```

### Applications

```{r}
STORAGE_UTIL_pods_summary <- CreateSummary(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "POD", "edge-iot-simulator"), "Pod")
```

## Network Utilization

```{r}
NET_UTIL <- TransfromNodeMetricsMetadata(NET_UTIL_RAW)
```

```{r}
INITIAL_TX_RX <- NET_UTIL %>% 
  group_by(nodeName, X_field, k8sResourceType, resourceName) %>% 
  slice(which.min(timestamp)) %>% 
  select(nodeName, sourceHost, k8sResourceType, resourceName, X_field, X_value) %>% 
  rename(X_value_initial = X_value)

COMBINED_NET_UTIL <- left_join(NET_UTIL, INITIAL_TX_RX, join_by(nodeName, sourceHost, k8sResourceType, resourceName, X_field))
COMBINED_NET_UTIL$X_value_final <- ((COMBINED_NET_UTIL$X_value - COMBINED_NET_UTIL$X_value_initial))
```

### Nodes

```{r}
COMBINED_NET_UTIL_NODES <- rbind(filterResourceUtilForNode(COMBINED_NET_UTIL, "rxBytes", "NODE", "pna-k8s-node"), filterResourceUtilForNode(COMBINED_NET_UTIL, "txBytes", "NODE", "pna-k8s-node"))

ggplot(COMBINED_NET_UTIL_NODES, aes(x=timestamp, y=X_value_final, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost), vars(X_field))
```

```{r}
COMBINED_NET_UTIL_NODES_TABLE <- CreateSummaryForNetUtil(COMBINED_NET_UTIL_NODES) %>% 
  rowwise %>% 
  pivot_wider(names_from = X_field, values_from = max)
names(COMBINED_NET_UTIL_NODES_TABLE) <- c("Node", "Tx", "Rx")
SaveLatexTable(COMBINED_NET_UTIL_NODES_TABLE, "Transmitted (Tx) and Received (Rx) Data in GB", "tx-rx-of-nodes", "net_util_nodes_summary.tex")
```

### Applications

```{r}
COMBINED_NET_UTIL_POD <- rbind(filterResourceUtilForNode(COMBINED_NET_UTIL, "rxBytes", "POD", "edge-iot-simulator"), filterResourceUtilForNode(COMBINED_NET_UTIL, "txBytes", "POD", "edge-iot-simulator"))

ggplot(COMBINED_NET_UTIL_POD, aes(x=timestamp, y=X_value_final, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost), vars(X_field))
```

## ICMP RTT

```{r}
# functions
TransfromNetworkMetricsMetadata <- function (df) {
  df$X_field <- as.factor(df$X_field)
  df$X_measurement <- as.factor(df$X_measurement)
  df$metricType <- as.factor(df$metricType)
  df$sourceHost <- as.factor(df$sourceHost)
  df$destinationHost <- as.factor(df$destinationHost)
  df$endTime <- as.POSIXct(df$endTime, format = "%Y-%m-%dT%H:%M:%OSZ")
  df$jobUUID <- as.factor(df$jobUUID)
  df <- merge(df, node_mapping, by.x = "sourceHost", by.y = "sourceHost")
  df <- merge(df, node_mapping_dest, by.x = "destinationHost", by.y = "destinationHost")
  return(df)
}
```

```{r}
ICMP_RTT <- TransfromNetworkMetricsMetadata(ICMP_RTT_RAW)

filterICMPRTT <- function(df, field) {
  return (df %>% filter(X_field == field))
}
```

```{r}
ICMP_RTT_SUMMARY <- filterICMPRTT(ICMP_RTT, "rttAvg")

ICMP_RTT_SUMMARY <- ICMP_RTT_SUMMARY %>% 
  group_by(nodeName, nodeNameDest) %>% 
  summarise(rtt = mean(X_value))

ICMP_RTT_SUMMARY_TABLE <- ICMP_RTT_SUMMARY %>% 
  rowwise %>% 
  pivot_wider(names_from = nodeNameDest, values_from = rtt, names_sort = TRUE)
```
```{r}
SaveLatexTable(ICMP_RTT_SUMMARY_TABLE, "Round-trip time between nodes", "rtt-of-nodes", "rtt_nodes_summary.tex")

icmp_rtt_plot <- ggplot(filterICMPRTT(ICMP_RTT, "rttAvg"), aes(x=endTime, y=X_value, group=nodeName)) + geom_line() + facet_grid(vars(nodeName), vars(nodeNameDest))
```

## TCP BW

```{r}
TCP_BW <- TransfromNetworkMetricsMetadata(TCP_BW_RAW)
TCP_BW$iperfRole <- as.factor(TCP_BW$iperfRole)

filterBW <- function(df, field, role) {
  return (df %>% filter(X_field %in% field) %>% filter(iperfRole == role))
}
```

```{r}
# src->dest->recever = Upload speed of src
# dest->src->receiver = Download speed of src
TCP_BW_SUMMARY <- filterBW(TCP_BW, "bitrate", "SENDER")

# build upload df
TCP_BW_SUMMARY <- TCP_BW_SUMMARY %>% 
  mutate(protocol = "TCP") %>% 
  group_by(nodeName, nodeNameDest, protocol) %>%
  summarise(min = round(min(X_value), 3),
            avg = round(mean(X_value), 3),
            max = round(max(X_value), 3),
            median = round(median(X_value), 3),
            std = round(sd(X_value), 3))

names(TCP_BW_SUMMARY) <- c("Source node", "Destination Node", "MIN", "AVG", "MAX", "MED", "STD")
SaveLatexTable(TCP_BW_SUMMARY, "TCP bandwidth between nodes", "tcp-bw-between-nodes", "tcp_bw_nodes_summary.tex")
```

```{r eval=FALSE}
source_nodes <- unique(TCP_BW_SUMMARY$nodeName)
dest_nodes <- unique(TCP_BW_SUMMARY$nodeNameDest)
nodes_unique <- intersect(source_nodes, dest_nodes)

df <- left_join(TCP_BW_SUMMARY, TCP_BW_SUMMARY, by = c("nodeName" = "nodeNameDest", "nodeNameDest" = "nodeName"))

df$nodeName <- as.factor(df$nodeName)
df$nodeNameDest <- as.factor(df$nodeNameDest)
df$nn <- as.numeric(df$nodeName)
df$nd <- as.numeric(df$nodeNameDest)
df %>% filter(!duplicated(pmin(nn, nd), pmax(nn, nd)))

df <- TCP_BW_SUMMARY %>% select(nodeName, nodeNameDest, avg)

TCP_BW_SUMMARY_UPLOAD <- TCP_BW_SUMMARY %>% 
  mutate(upload = TCP_BW_SUMMARY$X_value)
  
TCP_BW_SUMMARY_DOWNLOAD <- TCP_BW_SUMMARY %>% 
  mutate(download = TCP_BW_SUMMARY$X_value) %>% 
  rename(nodeName = nodeNameDest,
         nodeNameDest = nodeName)

TCP_BW_SUMMARY_COMPLETE <- left_join(TCP_BW_SUMMARY_UPLOAD, TCP_BW_SUMMARY_DOWNLOAD, by = join_by(nodeName, nodeNameDest))

tcp_bw_plot <- ggplot(filterBW(TCP_BW, "bitrate", "SENDER"), aes(x=endTime, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost), vars(destinationHost))
# TCP_BW %>% filter(iperfRole == "SENDER") %>% select(sourceHost, destinationHost, iperfRole ,startTime) %>% arrange(startTime)
```

## UDP

```{r}
UDP_BW <- TransfromNetworkMetricsMetadata(UDP_BW_RAW)
UDP_BW$iperfRole <- as.factor(UDP_BW$iperfRole)
```

```{r}
UDP_BW <- filterBW(UDP_BW, c("bitrate", "jitter", "lostDatagrams", "totalDatagrams"), "SENDER")

UDP_BW_PACKAGE_LOSS <- UDP_BW %>%  
  select(endTime, nodeName, nodeNameDest, metricUUID, X_field, X_value) %>% 
  filter(X_field %in% c("lostDatagrams", "totalDatagrams")) %>% 
  pivot_wider(names_from = X_field, values_from = X_value) %>% 
  mutate(lostDatagramsPercentage = (lostDatagrams / totalDatagrams) * 100)
  
UDP_BW_SUMMARY <- UDP_BW %>% 
  select(endTime, nodeName, nodeNameDest, metricUUID, X_field, X_value) %>% 
  filter(X_field %in% c("bitrate", "jitter")) %>% 
  mutate(protocol = "UDP") %>% 
  group_by(nodeName, nodeNameDest, protocol, X_field) %>%
  summarise(min = round(min(X_value), 3),
            avg = round(mean(X_value), 3),
            max = round(max(X_value), 3),
            median = round(median(X_value), 3),
            std = round(sd(X_value), 3))
```

```{r}
udp_bw_plot <- ggplot(filterBW(UDP_BW, "bitrate", "SENDER"), aes(x=endTime, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost), vars(destinationHost))
```

## REQUESTS

```{r}
# functions
TransfromRequests <- function (df) {
  df$X_field <- as.factor(df$X_field)
  df$X_measurement <- as.factor(df$X_measurement)
  df$sourceHost <- as.factor(df$sourceHost)
  df$destinationHost <- gsub("https://|:80", "", df$destinationHost)
  df <- merge(df, node_mapping, by.x = "destinationHost", by.y = "sourceHost")
  df$sourceHost <- gsub("-edge-iot-simulator", "-eis", df$sourceHost)
  names(df)[names(df) == "nodeName"] <- "destHost"
  df$destHost <- paste0(df$destHost, "-eis", "")
  return(df)
}
```

```{r}
REQUESTS <- TransfromRequests(REQUESTS_RAW)

REQUESTS_SUMMARY <- REQUESTS %>%
  select(timestamp, sourceHost, destHost, X_value) %>% 
  group_by(sourceHost, destHost) %>% 
  summarise(min = round(min(X_value), 3),
        avg = round(mean(X_value), 3),
        max = round(max(X_value), 3),
        median = round(median(X_value), 3),
        std = round(sd(X_value), 3)) %>% 
  rename(source = sourceHost, destination = destHost)

names(REQUESTS_SUMMARY) <- c("Source", "Destination", "MIN", "AVG", "MAX", "MED", "STD")
SaveLatexTable(REQUESTS_SUMMARY, "Round-trip times between applications", "rtt-between-applications", "requests_summary.tex")
```




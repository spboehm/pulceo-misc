# PULCEO data analytics

```{r}
library(ggplot2)
library(dplyr)
library(rjson)
```

## Preparation

Read raw data, generated by PULCEO.
```{r}
SUBFOLDER="test"
CPU_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "CPU_UTIL.csv", sep = "/"), skip = 3)
MEM_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "MEM_UTIL.csv", sep = "/"), skip = 3)
NET_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "NET_UTIL.csv", sep = "/"), skip = 3)
STORAGE_UTIL_RAW=read.csv(paste("raw", SUBFOLDER, "STORAGE_UTIL.csv", sep = "/"), skip = 3)
ICMP_RTT_RAW=read.csv(paste("raw", SUBFOLDER, "ICMP_RTT.csv", sep = "/"), skip = 3)
TCP_BW_RAW=read.csv(paste("raw", SUBFOLDER, "TCP_BW.csv", sep = "/"), skip = 3)
UDP_BW_RAW=read.csv(paste("raw", SUBFOLDER, "UDP_BW.csv", sep = "/"), skip = 3)
NODES_RAW=fromJSON(file=paste("raw", SUBFOLDER, "NODES.json", sep = "/"))
```

```{r}
node_mapping <- Reduce(rbind, lapply(NODES, function (x) {
  return(c(x$hostname, x$node$name))
}))

node_mapping <- as.data.frame(node_mapping)
names(node_mapping) <- c("hostname", "nodeName")
```


```{r}
# functions
TransfromNodeMetricsMetadata <- function (df) {
  df$X_field <- as.factor(df$X_field)
  df$k8sResourceType <- as.factor(df$k8sResourceType)
  df$resourceName <- as.factor(df$resourceName)
  df$X_measurement <- as.factor(df$X_measurement)
  df$metricType <- as.factor(df$metricType)
  df$sourceHost <- as.factor(df$sourceHost)
  df$timestamp <- as.POSIXct(df$timestamp, format = "%Y-%m-%dT%H:%M:%OSZ")
  df <- df %>% mutate(name = if_else(sourceHost == as.character(node_mapping[node_mapping == as.character(sourceHost),][1]), as.character(node_mapping[node_mapping == as.character(sourceHost),][2]), NA))
  return(df)
}

filterResourceUtilForNode <- function(df, field, resourceType, resource) {
  return(df %>% filter(X_field == field) %>% filter(k8sResourceType == resourceType) %>% filter(grepl(resource, resourceName)))
}

CreateSummary <- function(df) {
  return(df %>% 
    group_by(sourceHost) %>% 
    summarize(min = min(X_value),
              avg = mean(X_value),
              max = max(X_value),
              std = sd(X_value)))
}
```



## CPU utilization

```{r}
CPU_UTIL <- TransfromNodeMetricsMetadata(CPU_UTIL_RAW)
CPU_UTIL$name <- CPU_UTIL$sourceHost


```


```{r}
CreateSummary(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "NODE", "pna-k8s-node"))
```




```{r}
cpu_plot_node <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
cpu_plot_pod_pulceo_node_agent <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "POD", "pulceo-node-agent"), aes(x=timestamp, y=X_value, group=resourceName)) + geom_line() + facet_grid(vars(resourceName))
cpu_plot_pod_traefik <- ggplot(filterResourceUtilForNode(CPU_UTIL, "usageCPUPercentage", "POD", "traefik"), aes(x=timestamp, y=X_value, group=resourceName)) + geom_line() + facet_grid(vars(resourceName))
```





## Memory Utilization

```{r}
MEM_UTIL <- TransfromNodeMetricsMetadata(MEM_UTIL_RAW)
```

```{r}
mem_plot_node <- ggplot(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
mem_plot_node_pulceo_node_agent <- ggplot(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "POD", "pulceo-node-agent"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
mem_plot_node_traefik <-ggplot(filterResourceUtilForNode(MEM_UTIL, "usageMemoryPercentage", "POD", "traefik"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
```

## Network Utilization

```{r}
NET_UTIL <- TransfromNodeMetricsMetadata(NET_UTIL_RAW)
```

```{r}
net_util_node_rx_bytes <- ggplot(filterResourceUtilForNode(NET_UTIL, "rxBytes", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
net_util_node_tx_bytes <- ggplot(filterResourceUtilForNode(NET_UTIL, "txBytes", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
```

## Storage Utilization

```{r}
STORAGE_UTIL <- TransfromNodeMetricsMetadata(STORAGE_UTIL_RAW)
```

```{r}
storage_plot_node <- ggplot(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "NODE", "pna-k8s-node"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
storage_plot_pod_pulceo_node_agent <- ggplot(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "POD", "pulceo-node-agent"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
storage_plot_pod_pulceo_node_agent <- ggplot(filterResourceUtilForNode(STORAGE_UTIL, "usageStoragePercentage", "POD", "traefik"), aes(x=timestamp, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost))
```

## ICMP RTT

```{r}
# functions
TransfromNetworkMetricsMetadata <- function (df) {
  df$X_field <- as.factor(df$X_field)
  df$X_measurement <- as.factor(df$X_measurement)
  df$metricType <- as.factor(df$metricType)
  df$sourceHost <- as.factor(df$sourceHost)
  df$destinationHost <- as.factor(df$destinationHost)
  df$endTime <- as.POSIXct(df$endTime, format = "%Y-%m-%dT%H:%M:%OSZ")
  df$jobUUID <- as.factor(df$jobUUID)
  return(df)
}
```

```{r}
ICMP_RTT <- TransfromNetworkMetricsMetadata(ICMP_RTT_RAW)

filterICMPRTT <- function(df, field) {
  return (df %>% filter(X_field == field))
}
```

```{r}
icmp_rtt_plot <- ggplot(filterICMPRTT(ICMP_RTT, "rttAvg"), aes(x=endTime, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost), vars(destinationHost))
```

## TCP BW

```{r}
TCP_BW <- TransfromNetworkMetricsMetadata(TCP_BW_RAW)
TCP_BW$iperfRole <- as.factor(TCP_BW$iperfRole)

filterBW <- function(df, field, role) {
  return (df %>% filter(X_field == field) %>% filter(iperfRole == role))
}
```

```{r}
tcp_bw_plot <- ggplot(filterBW(TCP_BW, "bitrate", "RECEIVER"), aes(x=endTime, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost), vars(destinationHost))
```

```{r}
UDP_BW <- TransfromNetworkMetricsMetadata(UDP_BW_RAW)
UDP_BW$iperfRole <- as.factor(UDP_BW$iperfRole)
```

```{r}
udp_bw_plot <- ggplot(filterBW(UDP_BW, "bitrate", "RECEIVER"), aes(x=endTime, y=X_value, group=sourceHost)) + geom_line() + facet_grid(vars(sourceHost), vars(destinationHost))
```
